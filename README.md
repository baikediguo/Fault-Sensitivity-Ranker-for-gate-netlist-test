# Fault-Sensitivity-Ranker-for-gate-netlist-test
本项目旨在构建一个故障点智能选取系统（“故障敏感度评分器”）：在不进行显式故障注入的前提下，利用电路网表的结构/拓扑特征与图神经网络（GNN）自监督表征，对每个节点的故障敏感度进行打分与排序（Top-K）。随后仅对高分节点做少量注入仿真进行验证，从而在保证覆盖率可观的同时，显著减少仿真次数与验证成本。该系统面向 DFT/验证/可靠性工程流程，目标是成为“测试向导（test guidance）”——把资源优先投向更可能出问题、对系统行为更关键的节点。

## 为什么要“尽早识别敏感节点”？——具体收益

1.测试与仿真效率大增
* 传统做法是对海量节点做均匀或盲目注入，成本随规模指数级上涨；敏感度排序让我们把80% 的仿真预算投到 20% 的关键节点。

* 更少的 vvp/ATE 向量、缩短 iverilog 编译—运行—比对闭环的总时长。

2.更快的收敛，更少的回归

* 先聚焦高风险节点，可更早发现“致命故障路径”，缩短设计—验证—修复的闭环周期。

* 对回归场景，Top-K 白名单可作为**“冒烟测试”**优先集，使每次提交都有高价值的快速反馈。

3.DFT/ATPG/冗余优化的“放大器”

* 敏感度高的网点往往位于高扇出、强收敛或近时序边界位置，对测试可观测/可控性影响大。

* 排名结果可直接为 ATPG 目标化、观察点/控制点插入、选择性 TMR/ECC/Parity 加固提供量化依据。

4.可靠性与可制造性（Yield/Reliability）提升

* 对于软错误（SEU）/老化/变工艺角等场景，优先加固/监测高敏感节点可抑制系统级失效传播，提升稳定性与良率。

* 在安全/车规/航天等场景，有助于满足特定故障覆盖目标与合规性要求。

5.安全分析（Fault Attack Surface）辅助

* 在安全芯片/加密模块中，敏感节点排序有助于定位故障注入攻击的高价值表面，为攻防研究与缓解策略提供依据。

6.调试与 ECO 指导

* 敏感节点往往是调试“捷径”：日志/探针优先放在这些点上可提升诊断速度。

* ECO 前后对敏感度的变化可量化风险，帮助评估修改对可测性/可观测性的影响。

7.节省硬件/仿真资源成本

* 在算力/许可证受限的环境下（CI、云仿真、共享 farm），Top-K 策略能把同样预算转化为更高覆盖收益。

## 我们如何达成目标（与代码配套）
1. 预测阶段：unsup_sensitivity.py

* 基于 Pyverilog 解析网表，构建“网点+实例”的有向图；

* 提取结构/拓扑特征（度中心性、到输出的距离、近时序边界、重收敛度、深度等）；

* 使用 DGI 自监督方式学习节点嵌入，融合成敏感度分数，输出 gnn_rank.txt（全节点排序）。

* 无需任何故障注入，可作为快速预筛选。

2. 验证阶段：manual_validation.py
* 读取 gnn_rank.txt 的 Top-K 节点，与网表中可注入的合法目标求交集；

* 只对这部分高分节点分别注入 sa0/sa1，与 golden 输出对比，统计节点覆盖率/故障覆盖率；

* 以极少数量的注入，验证“排序是否有效”，为后续 DFT/ATPG/加固决策提供依据。

通过这套“先智能筛选，再小样本验证”的流程，能在不牺牲覆盖目标的前提下，显著压缩验证时间与算力花费，把工程力量集中在对系统行为最关键的网点上。

## 环境配置
为了快速设置，您可以使用以下命令一次性安装所有依赖项：

pip install -r requirements.txt

## 完整系统可以由以下模块组成：

1. Verilog Parser：解析网表为 AST

2. Graph Builder：从 AST 构建图（节点+边）

3. 特征提取器：从节点语义中构建结构语义特征

4. 评分器模型：图神经网络输出故障敏感度打分

5. Top-K 选点：选出前 K 个最可能故障点用于后续验证

## 下面将详细介绍实验的实现环节

## 第一步 配置标准单元库（cells.v我直接给出了，对于不同的网表，详细代码生成可见[fusa.github](https://github.com/baikediguo/fusa/blob/main/generate_cell_code.py) ）

功能：* 自动解析网表中的标准单元实例（例如，DFFX1，NAND2X0）
     * 根据预定义模板为每种单元类型生成行为Verilog模型
     * 保留原始端口顺序以兼容LEC* 处理顺序元件的特殊寄存器输出

## 第二步 testbench 初始化（tb.v）
要求:
* 将cells.v和tb.v放在同一个目录下
* 测试平台（tb.v）必须正确实例化PE模块并映射端口
* 确保存在1ns/1ps时间尺度的指令，以进行正确的定时仿真。

## 第三步 没有显式注入故障的情况下，对 Verilog 电路网表中每个节点的故障可能性进行预测或排序（unsup_sensitivity.py）

#### 1. **初始化与工具模块**
- **功能**：设置随机种子、文件读取、归一化处理等基础工具
- **关键组件**：
  - `set_seed()`: 确保实验可重复性
  - `read_text()`: 安全读取文件内容
  - `safe_norm()`: 向量归一化（防除零错误）
  - `minmax_norm()`: 特征归一化到[0,1]区间
  - `z2u01()`: 将余弦值映射到[0,1]区间

#### 2. **Verilog解析与图构建**
- **功能**：将Verilog网表转换为有向图
- **关键组件**：
  - `parse_verilog_graph()`: 
    - 使用`pyverilog`解析AST
    - **节点类型**:
      - 线网节点(`wire`)：表示电路连线
      - 实例节点(`cell`)：表示逻辑门/寄存器
    - **边方向**:
      - 输入：线网 → 实例
      - 输出：实例 → 线网
    - **特殊标记**:
      - 输出节点(如Q/Z端口)
      - 时序单元(DFF/LATCH等)

#### 3. **结构特征提取**
- **功能**：计算拓扑特征量化节点重要性
- **`compute_struct_features()`提取10维特征**:
  1. 入度/出度
  2. PageRank中心性
  3. 介数中心性(采样加速)
  4. 特征向量中心性
  5. 到输出的最小/平均距离(取倒数)
  6. 重收敛度(2-hop输出重叠)
  7. 近时序单元标志
  8. 节点名长度(弱代理)
  9. 输出节点标志
  10. 深度(受限BFS的最大深度)

#### 4. **图数据构建**
- **功能**：转换为PyG兼容格式
- **`build_pyg_data()`处理流程**:
  1. 节点类型one-hot编码
  2. 拼接12维特征向量：
     - 类型编码 + 10个结构特征 + 输出标志
  3. 构建有向边索引
  4. 保留节点ID与名称映射

#### 5. **自监督学习模型**
- **架构**:
  - **编码器**：3层GIN卷积
    ```python
    GINConv(Linear→ReLU→Linear→ReLU)
    ```
  - **判别器**：DGI对比学习
    - 正样本：原始图嵌入
    - 负样本：特征置换的图
    - 目标：最大化图级摘要与节点嵌入互信息
- **训练**:
  - 150轮Adam优化
  - 损失函数：`-log(σ(pos)) - log(1-σ(neg))`

#### 6. **敏感度融合评分**
- **`fuse_scores()`融合策略**:
  ```python
  score = 0.25*centrality    # (PR+介数+特征向量)/3
         + 0.25*proximity     # 距离倒数(min/avg)
         + 0.20*reconv        # 重收敛度
         + 0.15*near_ff       # 时序边界标志
         + 0.15*embed_sim     # 与输出节点嵌入的余弦相似度
  ```

#### 7. **主控流程**
- **执行步骤**:
  1. 解析命令行参数
  2. Verilog→有向图转换
  3. 提取拓扑特征
  4. 构建PyG数据
  5. DGI自监督训练
  6. 融合特征评分
  7. 输出Top-K敏感节点

### 关键创新点
1. **无监督故障预测**：  
   无需故障注入标签，通过结构特征+图嵌入预测敏感度

2. **特征工程**：  
   融合10种拓扑特征，涵盖：
   - 中心性(全局重要性)
   - 路径特性(接近输出程度)
   - 时序特性(近FF边界)
   - 结构特性(重收敛度)

3. **多模态融合**：  
   ```数学公式
   Score = α·Struct + β·Embed
   ```
   结构特征(可解释) + 图嵌入(上下文感知)

4. **高效性优化**：  
   - 介数中心性采用采样近似
   - 深度计算使用受限BFS
   - 时序单元邻近标志替代全路径分析

### 输出说明
- **结果文件**：`gnn_rank.txt`
  ```text
  net_name 0.8765
  cell_name 0.8123
  ...
  ```
- **排序依据**：得分降序，高分节点更敏感

> 典型高敏感节点特征：位于关键路径、高扇出、近时序边界、重收敛区域、与输出节点嵌入相似度高。

